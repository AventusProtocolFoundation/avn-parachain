name: CI PR

on:
  pull_request_target:
    branches:
      - main
      - DEVOPS-365-update-the-ci-to-remove-the-public-private-repo-logic-and-add-all-the-release-creation-code-from-the-private-repo

concurrency:
  group: ${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  set-up-job:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-20.04
    timeout-minutes: 90
    steps:
      - name: Check out
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
      
      - name: Install cargo-edit
        uses: baptiste0928/cargo-install@v2
        with:
          crate: cargo-edit

      - name: Verify PR type
        env:
          description: ${{ github.event.pull_request.body }}
        run: |
          ./.github/ci-scripts/verify_pr_type.sh "$description" "${{ github.event_name }}"

      - name: skip testing
        id: skip_tests
        run: |
          git checkout ${{ github.head_ref }}
          commit_message=$(git log -1 --pretty=format:"%s")
          git checkout $GITHUB_SHA

          SKIP_TESTS=$([[ "$commit_message" == *"tag:skip_testing"* ]] && echo true || echo false)
          echo "SKIP_TESTS=$SKIP_TESTS" >> "$GITHUB_ENV"
          echo "SKIP_TESTS=$SKIP_TESTS" >> "$GITHUB_OUTPUT"

      - name: Get latest repo tag
        if: env.RELEASE == 'true' && env.SKIP_TESTS != 'true'
        id: latest_repo_tag
